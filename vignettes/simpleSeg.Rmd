---
title: "Spatial Mixed-Effects Modelling with spicy"
date: "`r BiocStyle::doc_date()`"
params:
  test: FALSE
author:
- name: Alexander Nicholls
  affiliation:  
  - School of Mathematics and Statistics, University of Sydney, Australia
- name: Ellis Patrick
  affiliation:
  - &WIMR Westmead Institute for Medical Research, University of Sydney, Australia
  - School of Mathematics and Statistics, University of Sydney, Australia
- name: Nicolas Canete
  affiliation:  
  - &WIMR Westmead Institute for Medical Research, University of Sydney, Australia
vignette: >
  %\VignetteIndexEntry{"Introduction to simpleSeg"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output: 
  BiocStyle::html_document
---
  
  ```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(BiocStyle)
```


```{r warning=FALSE, message=FALSE}
# load required packages
library(simpleSeg)
```

# Installation

```{r, eval = FALSE}
# Install the development version from GitHub:
# install.packages("devtools")
devtools::install_github("SydneyBioX/simpleSeg")
```

# Overview
`simpleSeg` provides a structured pipeline for segmentation of cellular tiff stacks and the normalization of features, priming cells for classification / clustering.


# Load example data


```{r}

# Get path to image directory
pathToImages <- system.file("extdata", package = "simpleSeg")

# Get directories of images
imageDirs <- dir(pathToImages, full.names = TRUE)
names(imageDirs) <- dir(pathToImages, full.names = FALSE)

# Get files in each directory
files <- sapply(imageDirs, list.files, pattern = "tif", full.names = TRUE, simplify = FALSE)

# Read files with readImage from EBImage
images <- lapply(files, EBImage::readImage, as.is = TRUE)

# Convert to cytoImageList
images <- cytomapper::CytoImageList(images)
mcols(images)$ImageNb <- names(images)



```

# Quick start
`simpleSeg` accepts an `Image`, `list` of `Image`'s, or `CytoImageList` as input and generates a `CytoImageList` of masks as output. The minimum input required is an `Image` and the nuclei marker to be used.

# Segmentation

By default, `simpleSeg` identifies nuclei marker expression using principal component analysis and individual nuclei via watershedding. Nuclei are dilated out by 3 pixels to capture the cytoplasm.

The user may specify the image transformation used using the `transform` argument.

```{r, out.width = "400px"}
masks <- simpleSeg::simpleSeg(images,
                              nucleus = "HH3",
                              transform = "sqrt")

display(colorLabels(masks[[1]]))

imageRGB <- rgbImage(green = 0.5 * images[[1]][,,"Nuc"],
                  blue = 0.5 * images[[1]][,,"COLI"],
                  red = 0.5 * images[[1]][,,"HLADRDPDQ"])
segmented <- paintObjects(masks[[1]], imageRGB, col='#ffffff')
display(segmented)
```


The `measureObjects` function from the `cytomapper` package can then be used to generate a `SingleCellExperement` object from the images and masks
```{r, out.width = "400px"}
cell.sce <- measureObjects(masks, images, img_id = "ImageNb")
```

## Methods of watershedding
The user may specify how watershedding is to be performed. The default is `watershed = "combine"` which multiplies this distance map by the raw nuclei marker signal, thus incorporating some information as to the location of the nuclei into the watershedding process. Other options include `watershed = "distance"` which performs watershedding on a distance map of the thresholded nuclei signal and `watershed = "intensity"` which performs watershedding using the intensity of the nuclei marker.


## Methods of cell body identification
The cell body can also be identified in `simpleSeg` using models of varying complexity, specified with the `cellBody` argument.



### Dilatation
The default and most basic is dilation (`cellBody = "dilate"`). The size of the dilatation in pixels may be specified with the `discDize` argument.
```{r, out.width = "400px"}
masks <- simpleSeg::simpleSeg(images,
                   nucleus = 25,
                   transform = "sqrt",
                   cellBody = "dilate",
                   discSize = 3)
display(colorLabels(masks[[1]]))

segmented <- paintObjects(masks[[1]], imageRGB, col='#ffffff')
display(segmented)
```


### Disc Model
`cellBody = "diskModel` uses all the markers to predict the presence of dilated 'discs' around the nuclei. The model therefore learns which markers are typically present in the cell cytoplasm and generates a mask based on this.
```{r, out.width = "400px"}
masks <- simpleSeg::simpleSeg(images,
                   nucleus = 25,
                   transform = "sqrt",
                   cellBody = "discModel")
display(colorLabels(masks[[1]]))

segmented <- paintObjects(masks[[1]], imageRGB, col='#ffffff')
display(segmented)
```



### Marker model
Finally the user may specify one or multiple dedicated cytoplasm markers to predict the cytoplasm. This can be done using `cellBody = [marker name/index]` as below.
```{r, out.width = "400px"}
masks <- simpleSeg::simpleSeg(images,
                   nucleus = 25,
                   transform = "sqrt",
                   cellBody = 26)
display(colorLabels(masks[[1]]))

segmented <- paintObjects(masks[[1]], imageRGB, col='#ffffff')
display(segmented)

```


# Parallel Processing
`simpleSeg` also supports parallel processing, with the `cores` argument being used to specify how many cores should be used.

```{r eval = FALSE}
masks <- simpleSeg::simpleSeg(images,
                              cores = 5)
```


# Normalizing cells
Once cellular features have been extracted into a SingleCellExperement or dataframe, these features may then be normalized using the `normalizeCells`function. any number of Transformations: `asinh`, `sqrt`. and Normalization methods `mean`(dividing the marker intensities by their mean), `minMax` (subtracts the minimum value and scales markers between 0 and 1), `trim99` (sets the highest 1% of values to the value of the 99th percentile), `PC1` (removes the 1st principle component) can be performed with one call of the function, in the order specified by the user.
```{r}
cell.sce.norm <- normalizeCells(cellSCE,
                                assayIn = "counts",
                                assayOut = "norm",
                                imageID = "imageNb",
                                transformation = "sqrt",
                                method = c("trim99", "minmax"))
```
## Session Info
```{r}
sessionInfo()
```

<!-- ## Tissue mask -->
<!-- When the entirety of a circular tissue sample is encompassed within an image, the user may with to isolate this circular area, and remove background noise from the remainder of the image. This process is facilitated using the `tissueMask` parameter in `transforms`, which, when selected creates a mask of the tissue within the image. Specified tissue channels can be specified in the `tissueIndex` parameter, by default all channels are used. -->



---
title: "Spatial Mixed-Effects Modelling with spicy"
date: "`r BiocStyle::doc_date()`"
params:
  test: FALSE
author:
- name: Alexander Nicholls
  affiliation:  
  - School of Mathematics and Statistics, University of Sydney, Australia
- name: Ellis Patrick
  affiliation:
  - &WIMR Westmead Institute for Medical Research, University of Sydney, Australia
  - School of Mathematics and Statistics, University of Sydney, Australia
- name: Nicolas Canete
  affiliation:  
  - &WIMR Westmead Institute for Medical Research, University of Sydney, Australia
vignette: >
  %\VignetteIndexEntry{"Introduction to simpleSeg"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output: 
  BiocStyle::html_document
---
  
  ```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(BiocStyle)
```


```{r warning=FALSE, message=FALSE}
# load required packages
library(simpleSeg)
```

# Installation

```{r, eval = FALSE}
# Install the development version from GitHub:
# install.packages("devtools")
devtools::install_github("SydneyBioX/simpleSeg")
```

# Overview
`simpleSeg` provides a structured pipeline for segmentation of cellular tiff stacks and the normalization of features, priming cells for classification / clustering

# Quick start
`simpleSeg` accepts an image, image list or CytoImageList as input, and generates a CytoImageList of masks as output.

```{r}
# Reading in sample data
data(pancreasImages)
summary(pancreasImages)
```

The minimum input required is the image/image list and the nuclei marker to be used. 

# Segmentation
## Quick Started

By default, `simpleSeg` identifies nuclei marker expression using principal component analysis and individual nuclei via watershedding. Nuclei are dilated out by 3 pixels to capture the cytoplasm.

The user may specify the image transformation used using the `transform` argument.

```{r, out.width = "400px"}
masks <- simpleSeg(pancreasImages, 
                   transform = c("sqrt"), 
                   watershed = "distance")
display(masks[[1]])

cells <- rgbImage(green = 0.05 * pancreasImages[[1]][,,1], 
                  blue = 0.03 * pancreasImages[[1]][,,2], 
                  red = 0.05 * pancreasImages[[1]][,,5])
segmented <- paintObjects(masks[[1]], cells, col='#ffffff')
display(segmented)
```


The `measureObjects` function from the `cytomapper` package can then be used to generate a `SingleCellExperement` object from the images and masks
```{r, out.width = "400px"}
mcols(masks)$ImageNb <- c("1", "2", "3")
mcols(pancreasImages)$ImageNb <- c("1", "2", "3")

cell.sce <- measureObjects(masks, pancreasImages, img_id = "ImageNb")
```

## Methods of watershedding
The user may specify how watershedding is to be performed. `watershed = "distance"` (above) performs watershedding on a distance map of the thresholded nuclei signal.

`watershed = "combine"` (default; below) multiplies this distance map by the raw nuclei marker signal, thus incorporating some information as to the location of the nuclei into the watershedding process.
```{r, out.width = "400px"}
masks <- simpleSeg(pancreasImages, 
                   nucleus = "H3",
                   transform = "asinh", 
                   watershed = "combine")
display(masks[[1]])

cells <- rgbImage(green = 0.05 * pancreasImages[[1]][,,1], 
                  blue = 0.03 * pancreasImages[[1]][,,2], 
                  red = 0.05 * pancreasImages[[1]][,,5])
segmented <- paintObjects(masks[[1]], cells, col='#ffffff')
display(segmented)
```

## Methods of cell body identification
The cell body can also be identified in `simpleSeg` using models of varying complexity, specified with the `cellBody` argument. 

### Dilatation
The default and most basic is dilation (`cellBody = "dilate"`). The size of the dilatation in pixels may be specified with the `discDize` argument. 
```{r, out.width = "400px"}
masks <- simpleSeg(pancreasImages, 
                   nucleus = "H3",
                   transform = "asinh",
                   cellBody = "dilate",
                   discSize = 3)
display(masks[[1]])

cells <- rgbImage(green = 0.05 * pancreasImages[[1]][,,1], 
                  blue = 0.03 * pancreasImages[[1]][,,2], 
                  red = 0.05 * pancreasImages[[1]][,,5])
segmented <- paintObjects(masks[[1]], cells, col='#ffffff')
display(segmented)
```


### Disc Model
`cellBody = "diskModel` uses all the markers to predict the presence of dilated 'discs' around the nuclei. The model therefore learns which markers are typically present in the cell cytoplasm and generates a mask based on this. 
```{r, out.width = "400px"}
masks <- simpleSeg(pancreasImages, 
                   nucleus = "H3",
                   transform = "asinh",
                   cellBody = "discModel")
display(masks[[1]])

cells <- rgbImage(green = 0.05 * pancreasImages[[1]][,,1], 
                  blue = 0.03 * pancreasImages[[1]][,,2], 
                  red = 0.05 * pancreasImages[[1]][,,5])
segmented <- paintObjects(masks[[1]], cells, col='#ffffff')
display(segmented)
```

### Marker model
Finally the user may specify 1 or multiple dedicated cytoplasm markers to predict the cytoplasm. This can be done using `cellBody = [marker name]` as below.
```{r, out.width = "400px"}
masks <- simpleSeg(pancreasImages,
                   nucleus = "H3",
                   transform = "asinh",
                   cellBody = "CD8a")
display(masks[[1]])

cells <- rgbImage(green = 0.05 * pancreasImages[[1]][,,1], 
                  blue = 0.03 * pancreasImages[[1]][,,2], 
                  red = 0.05 * pancreasImages[[1]][,,5])
segmented <- paintObjects(masks[[1]], cells, col='#ffffff')
display(segmented)
```


# Parallel Processing
`simpleSeg` also supports parallel processing, with the `cores` argument being used to specify how many cores should be used.

```{r}
masks <- simpleSeg(pancreasImages, cores = 5)
```

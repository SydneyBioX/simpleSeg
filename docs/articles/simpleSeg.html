<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="simpleSeg">
<title>Segmenting and normalizing multiplexed imaging data with simpleSeg • simpleSeg</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Segmenting and normalizing multiplexed imaging data with simpleSeg">
<meta property="og:description" content="simpleSeg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">simpleSeg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/simpleSeg.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/SydneyBioX/simpleSeg/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Segmenting and normalizing multiplexed imaging data with simpleSeg</h1>
                        <h4 data-toc-skip class="author">Alexander
Nicholls</h4>
            <address class="author_afil">
      School of Mathematics and Statistics, University of Sydney,
Australia<br><h4 data-toc-skip class="author">Ellis
Patrick</h4>
            <address class="author_afil">
      Westmead Institute for Medical Research, University of Sydney,
AustraliaSchool of Mathematics and Statistics, University of Sydney,
Australia<br><h4 data-toc-skip class="author">Nicolas
Canete</h4>
            <address class="author_afil">
      Westmead Institute for Medical Research, University of Sydney,
Australia<br><h4 data-toc-skip class="date">10 August 2023</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SydneyBioX/simpleSeg/blob/HEAD/vignettes/simpleSeg.Rmd" class="external-link"><code>vignettes/simpleSeg.Rmd</code></a></small>
      <div class="d-none name"><code>simpleSeg.Rmd</code></div>
    </address>
</address>
</address>
</div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sydneybiox.github.io/simpleSeg/">simpleSeg</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/aoles/EBImage" class="external-link">EBImage</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BodenmillerGroup/cytomapper" class="external-link">cytomapper</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install the package from Bioconductor</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"simpleSeg"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The <code>simpleSeg</code> package extends existing bioconductor
packages such as <code>cytomapper</code> and <code>EBImage</code> by
providing a structured pipeline for creating segmentation masks from
multiplexed cellular images in the form of tiff stacks. This allows for
the single cell information of these images to be extracted in R,
without the need for external segmentation programs.
<code>simpleSeg</code> also facilitates the normalisation of cellular
features after these features have been extracted from the image,
priming cells for classification / clustering. These functions leverage
the functionality of the <a href="https://bioconductor.org/packages/release/bioc/vignettes/EBImage/inst/doc/EBImage-introduction.html" class="external-link"><code>EBImage</code></a>
package on Bioconductor. For more flexibility when performing your
segmentation in R we recommend learning to use the <code>EBimage</code>
package. A key strength of <code>simpleSeg</code> is that we have coded
multiple ways to perform some simple segmentation operations as well as
incorporating multiple automatic procedures to optimise key parameters
when these aren’t specified.</p>
</div>
<div class="section level2">
<h2 id="load-example-data">Load example data<a class="anchor" aria-label="anchor" href="#load-example-data"></a>
</h2>
<p>In the following we will reanalyse two MIBI-TOF images from <a href="https://www.sciencedirect.com/science/article/pii/S0092867421014860?via%3Dihub#!" class="external-link">(Risom
et al., 2022)</a> profiling the spatial landscape of ductal carcinoma in
situ (DCIS), which is a pre-invasive lesion that is thought to be a
precursor to invasive breast cancer (IBC). These images are stored in
the “extdata” folder in the package. When the path to this folder is
identified, we can read these images into R using <code>readImage</code>
from <code>EBImage</code> and store these as a
<code>CytoImageList</code> using the <code>cytomapper</code>
package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Get path to image directory</span></span>
<span><span class="va">pathToImages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"simpleSeg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get directories of images</span></span>
<span></span>
<span><span class="va">imageDirs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">pathToImages</span>, <span class="st">"Point"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">imageDirs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">pathToImages</span>, <span class="st">"Point"</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Get files in each directory</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">imageDirs</span>,</span>
<span>  <span class="va">list.files</span>,</span>
<span>  pattern <span class="op">=</span> <span class="st">"tif"</span>,</span>
<span>  full.names <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read files with readImage from EBImage</span></span>
<span><span class="va">images</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">files</span>, <span class="fu">EBImage</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/EBImage/man/io.html" class="external-link">readImage</a></span>, as.is <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to cytoImageList</span></span>
<span><span class="va">images</span> <span class="op">&lt;-</span> <span class="fu">cytomapper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cytomapper/man/CytoImageList.html" class="external-link">CytoImageList</a></span><span class="op">(</span><span class="va">images</span><span class="op">)</span></span>
<span><span class="fu">mcols</span><span class="op">(</span><span class="va">images</span><span class="op">)</span><span class="op">$</span><span class="va">imageID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">images</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="segmentation">Segmentation<a class="anchor" aria-label="anchor" href="#segmentation"></a>
</h2>
<p><code>simpleSeg</code> accepts an <code>Image</code>,
<code>list</code> of <code>Image</code>’s, or <code>CytoImageList</code>
as input and generates a <code>CytoImageList</code> of masks as output.
Here we will use the histone H3 channel in the image as a nuclei marker
for segmentation. By default, <code>simpleseg</code> will isolate
individual nuclei by watershedding using a combination of the intensity
of this marker and a distance map. Nuclei are dilated out by 3 pixels to
capture the cytoplasm. The user may also specify simple image
transformations using the <code>transform</code> argument.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">masks</span> <span class="op">&lt;-</span> <span class="fu">simpleSeg</span><span class="fu">::</span><span class="fu"><a href="../reference/simpleSeg.html">simpleSeg</a></span><span class="op">(</span><span class="va">images</span>,</span>
<span>                              nucleus <span class="op">=</span> <span class="st">"HH3"</span>,</span>
<span>                              transform <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="visualise-separation">Visualise separation<a class="anchor" aria-label="anchor" href="#visualise-separation"></a>
</h3>
<p>The <code>display</code> and <code>colorLabels</code> functions in
<code>EBImage</code> make it very easy to examine the performance of the
cell segmentation. The great thing about <code>display</code> is that if
used in an interactive session it is very easy to zoom in and out of the
image.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualise segmentation performance one way.</span></span>
<span><span class="fu">EBImage</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/display.html" class="external-link">display</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/colorLabels.html" class="external-link">colorLabels</a></span><span class="op">(</span><span class="va">masks</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="simpleSeg_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="visualise-outlines">Visualise outlines<a class="anchor" aria-label="anchor" href="#visualise-outlines"></a>
</h3>
<p>The <code>plotPixels</code> function in <code>cytomapper</code> make
it easy to overlay the masks on top of the intensities of 6 markers.
Here we can see that the segmentation appears to be performing
reasonably.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Visualise segmentation performance another way.</span></span>
<span><span class="fu">cytomapper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cytomapper/man/plotPixels.html" class="external-link">plotPixels</a></span><span class="op">(</span>image <span class="op">=</span> <span class="va">images</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                       mask <span class="op">=</span> <span class="va">masks</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                       img_id <span class="op">=</span> <span class="st">"imageID"</span>, </span>
<span>                       colour_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PanKRT"</span>, <span class="st">"GLUT1"</span>, <span class="st">"HH3"</span>, <span class="st">"CD3"</span>, <span class="st">"CD20"</span><span class="op">)</span>, </span>
<span>                       display <span class="op">=</span> <span class="st">"single"</span>,</span>
<span>                       colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>HH3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>,<span class="st">"blue"</span><span class="op">)</span>, </span>
<span>                                     CD3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>,<span class="st">"purple"</span><span class="op">)</span>,</span>
<span>                                     CD20 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>,<span class="st">"green"</span><span class="op">)</span>,</span>
<span>                                     GLUT1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span>,</span>
<span>                                     PanKRT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"yellow"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       bcg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>HH3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1.5</span><span class="op">)</span>, </span>
<span>                                     CD3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1.5</span><span class="op">)</span>,</span>
<span>                                     CD20 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1.5</span><span class="op">)</span>,</span>
<span>                                     GLUT1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1.5</span><span class="op">)</span>,</span>
<span>                                     PanKRT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       legend <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="simpleSeg_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="methods-of-watershedding">Methods of Watershedding<a class="anchor" aria-label="anchor" href="#methods-of-watershedding"></a>
</h3>
<p>Watershedding is a method which treats images as topographical maps
in order to identify individual objects and the borders between
them.</p>
<p>The user may specify how watershedding is to be performed by using
the <code>watershed</code> argument in <code>simpleSeg</code>.</p>
<table class="table">
<colgroup>
<col width="25%">
<col width="37%">
<col width="37%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th align="center">Description</th>
<th align="center"></th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span style="font-family: 'Courier New', monospace;">“distance”</span></td>
<td align="center"><span style="font-family: 'Courier New', monospace;">Performs
watershedding on a distance map of the thresholded nuclei signal. With a
pixels distance being defined as the distance from the closest
background signal.</span></td>
<td align="center"></td>
</tr>
<tr class="even">
<td><span style="font-family: 'Courier New', monospace;">“intensity”</span></td>
<td align="center"><span style="font-family: 'Courier New', monospace;">Performs
watershedding using the intensity of the nuclei marker.</span></td>
<td align="center"></td>
</tr>
<tr class="odd">
<td><span style="font-family: 'Courier New', monospace;">“combine”</span></td>
<td align="center"><span style="font-family: 'Courier New', monospace;">Combines the
previous two methods by multiplying the distance map by the nuclei
marker intensity.</span></td>
<td align="center"></td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="methods-of-cell-body-identification">Methods of cell body identification<a class="anchor" aria-label="anchor" href="#methods-of-cell-body-identification"></a>
</h3>
<p>The cell body can also be identified in <code>simpleSeg</code> using
models of varying complexity, specified with the <code>cellBody</code>
argument.</p>
<table class="table">
<colgroup>
<col width="25%">
<col width="37%">
<col width="37%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th align="center">Description</th>
<th align="center"></th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span style="font-family: 'Courier New', monospace;">“dilation”</span></td>
<td align="center"><span style="font-family: 'Courier New', monospace;">Dilates the
nuclei by an amount defined by the user. The size of the dilatation in
pixels may be specified with the <code>discDize</code>
argument.</span></td>
<td align="center"></td>
</tr>
<tr class="even">
<td><span style="font-family: 'Courier New', monospace;">“discModel”</span></td>
<td align="center"><span style="font-family: 'Courier New', monospace;">Uses all the
markers to predict the presence of dilated ‘discs’ around the nuclei.
The model therefore learns which markers are typically present in the
cell cytoplasm and generates a mask based on this.</span></td>
<td align="center"></td>
</tr>
<tr class="odd">
<td><span style="font-family: 'Courier New', monospace;">“marker”</span></td>
<td align="center"><span style="font-family: 'Courier New', monospace;">The user may
specify one or multiple dedicated cytoplasm markers to predict the
cytoplasm. This can be done using
<code>cellBody = "marker name"/"index"</code></span></td>
<td align="center"></td>
</tr>
<tr class="even">
<td><span style="font-family: 'Courier New', monospace;">“None”</span></td>
<td align="center"><span style="font-family: 'Courier New', monospace;">The nuclei mask
is returned directly.</span></td>
<td align="center"></td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="parallel-processing">Parallel Processing<a class="anchor" aria-label="anchor" href="#parallel-processing"></a>
</h3>
<p><code>simpleSeg</code> also supports parallel processing, with the
<code>cores</code> argument being used to specify how many cores should
be used.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">masks</span> <span class="op">&lt;-</span> <span class="fu">simpleSeg</span><span class="fu">::</span><span class="fu"><a href="../reference/simpleSeg.html">simpleSeg</a></span><span class="op">(</span><span class="va">images</span>,</span>
<span>                              nucleus <span class="op">=</span> <span class="st">"HH3"</span>,</span>
<span>                              cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="summarise-cell-features">Summarise cell features<a class="anchor" aria-label="anchor" href="#summarise-cell-features"></a>
</h2>
<p>In order to characterise the phenotypes of each of the segmented
cells, <code>measureObjects</code> from <code>cytomapper</code> will
calculate the average intensity of each channel within each cell as well
as a few morphological features. The channel intensities will be stored
in the <code>counts assay</code> in a <code>SingleCellExperiment</code>.
Information on the spatial location of each cell is stored in
<code>colData</code> in the <code>m.cx</code> and <code>m.cy</code>
columns. In addition to this, it will propagate the information we have
store in the <code>mcols</code> of our <code>CytoImageList</code> in the
<code>colData</code> of the resulting
<code>SingleCellExperiment</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cellSCE</span> <span class="op">&lt;-</span> <span class="fu">cytomapper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cytomapper/man/measureObjects.html" class="external-link">measureObjects</a></span><span class="op">(</span><span class="va">masks</span>, <span class="va">images</span>, img_id <span class="op">=</span> <span class="st">"imageID"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="normalising-cells">Normalising cells<a class="anchor" aria-label="anchor" href="#normalising-cells"></a>
</h2>
<p>Once cellular features have been extracted into a
SingleCellExperement or dataframe, these features may then be normalised
using the <code>normalizeCells</code>function, transformed by any number
of transformations (e.g., <code>asinh</code>, <code>sqrt</code>) and
normalisation methods.</p>
<p><code>mean</code>(Divides the marker cellular marker intensities by
their mean), <code>minMax</code> (Subtracts the minimum value and scales
markers between 0 and 1.), <code>trim99</code> (Sets the highest 1% of
values to the value of the 99th percentile.), <code>PC1</code> (Removes
the 1st principal component) can be performed with one call of the
function, in the order specified by the user.</p>
<table class="table">
<colgroup>
<col width="25%">
<col width="37%">
<col width="37%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th align="center">Description</th>
<th align="center"></th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span style="font-family: 'Courier New', monospace;">“mean”</span></td>
<td align="center"><span style="font-family: 'Courier New', monospace;">Divides the
marker cellular marker intensities by their mean.</span></td>
<td align="center"></td>
</tr>
<tr class="even">
<td><span style="font-family: 'Courier New', monospace;">“minMax”</span></td>
<td align="center"><span style="font-family: 'Courier New', monospace;">Subtracts the
minimum value and scales markers between 0 and 1.</span></td>
<td align="center"></td>
</tr>
<tr class="odd">
<td><span style="font-family: 'Courier New', monospace;">“trim99”</span></td>
<td align="center"><span style="font-family: 'Courier New', monospace;">Sets the highest
1% of values to the value of the 99th percentile.`</span></td>
<td align="center"></td>
</tr>
<tr class="even">
<td><span style="font-family: 'Courier New', monospace;">“PC1”</span></td>
<td align="center"><span style="font-family: 'Courier New', monospace;">Removes the 1st
principal component) can be performed with one call of the function, in
the order specified by the user.</span></td>
<td align="center"></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Transform and normalise the marker expression of each cell type.</span></span>
<span><span class="co"># Use a square root transform, then trimmed the 99 quantile </span></span>
<span><span class="va">cellSCE</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/normalizeCells.html">normalizeCells</a></span><span class="op">(</span><span class="va">cellSCE</span>,</span>
<span>                          assayIn <span class="op">=</span> <span class="st">"counts"</span>,</span>
<span>                          assayOut <span class="op">=</span> <span class="st">"norm"</span>,</span>
<span>                          imageID <span class="op">=</span> <span class="st">"imageID"</span>,</span>
<span>                          transformation <span class="op">=</span> <span class="st">"sqrt"</span>,</span>
<span>                          method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trim99"</span>, <span class="st">"minMax"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="qc-normalisation">QC normalisation<a class="anchor" aria-label="anchor" href="#qc-normalisation"></a>
</h3>
<p>We could check to see if the marker intensities of each cell require
some form of transformation or normalisation. Here we extract the
intensities from the <code>counts</code> assay. Looking at PanKRT which
should be expressed in the majority of the tumour cells, the intensities
are clearly very skewed.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Extract marker data and bind with information about images</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">cellSCE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu">assay</span><span class="op">(</span><span class="va">cellSCE</span>, <span class="st">"counts"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plots densities of PanKRT for each image.</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PanKRT</span>, colour <span class="op">=</span> <span class="va">imageID</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"PanKRT expression"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simpleSeg_files/figure-html/unnamed-chunk-10-1.png" width="480"></p>
<p>We can see that the normalised data stored in the norm assay appears
more bimodal, not perfect, but likely sufficient for clustering.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Extract normalised marker information.</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">cellSCE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu">assay</span><span class="op">(</span><span class="va">cellSCE</span>, <span class="st">"norm"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plots densities of normalised PanKRT for each image.</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PanKRT</span>, colour <span class="op">=</span> <span class="va">imageID</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"PanKRT expression"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simpleSeg_files/figure-html/unnamed-chunk-11-1.png" width="480"></p>
</div>
<div class="section level3">
<h3 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.3.1 (2023-06-16)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">#&gt; Running under: Debian GNU/Linux 12 (bookworm)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.21.so;  LAPACK version 3.11.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: Australia/Sydney</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">#&gt; [8] base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt;  [1] cytomapper_1.13.0           SingleCellExperiment_1.23.0</span></span>
<span><span class="co">#&gt;  [3] SummarizedExperiment_1.31.1 Biobase_2.61.0             </span></span>
<span><span class="co">#&gt;  [5] GenomicRanges_1.53.1        GenomeInfoDb_1.37.2        </span></span>
<span><span class="co">#&gt;  [7] IRanges_2.35.2              S4Vectors_0.39.1           </span></span>
<span><span class="co">#&gt;  [9] BiocGenerics_0.47.0         MatrixGenerics_1.13.1      </span></span>
<span><span class="co">#&gt; [11] matrixStats_1.0.0           EBImage_4.43.0             </span></span>
<span><span class="co">#&gt; [13] ggplot2_3.4.2               simpleSeg_1.1.2            </span></span>
<span><span class="co">#&gt; [15] BiocStyle_2.29.1           </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;   [1] RColorBrewer_1.1-3        jsonlite_1.8.7           </span></span>
<span><span class="co">#&gt;   [3] magrittr_2.0.3            spatstat.utils_3.0-3     </span></span>
<span><span class="co">#&gt;   [5] ggbeeswarm_0.7.2          magick_2.7.4             </span></span>
<span><span class="co">#&gt;   [7] farver_2.1.1              rmarkdown_2.23           </span></span>
<span><span class="co">#&gt;   [9] fs_1.6.3                  zlibbioc_1.47.0          </span></span>
<span><span class="co">#&gt;  [11] ragg_1.2.5                vctrs_0.6.3              </span></span>
<span><span class="co">#&gt;  [13] memoise_2.0.1             DelayedMatrixStats_1.23.0</span></span>
<span><span class="co">#&gt;  [15] RCurl_1.98-1.12           terra_1.7-39             </span></span>
<span><span class="co">#&gt;  [17] svgPanZoom_0.3.4          htmltools_0.5.5          </span></span>
<span><span class="co">#&gt;  [19] S4Arrays_1.1.5            raster_3.6-23            </span></span>
<span><span class="co">#&gt;  [21] Rhdf5lib_1.23.0           SparseArray_1.1.11       </span></span>
<span><span class="co">#&gt;  [23] rhdf5_2.45.1              sass_0.4.7               </span></span>
<span><span class="co">#&gt;  [25] bslib_0.5.0               htmlwidgets_1.6.2        </span></span>
<span><span class="co">#&gt;  [27] desc_1.4.2                cachem_1.0.8             </span></span>
<span><span class="co">#&gt;  [29] mime_0.12                 lifecycle_1.0.3          </span></span>
<span><span class="co">#&gt;  [31] pkgconfig_2.0.3           Matrix_1.5-3             </span></span>
<span><span class="co">#&gt;  [33] R6_2.5.1                  fastmap_1.1.1            </span></span>
<span><span class="co">#&gt;  [35] GenomeInfoDbData_1.2.10   shiny_1.7.4.1            </span></span>
<span><span class="co">#&gt;  [37] digest_0.6.33             colorspace_2.1-0         </span></span>
<span><span class="co">#&gt;  [39] rprojroot_2.0.3           dqrng_0.3.0              </span></span>
<span><span class="co">#&gt;  [41] textshaping_0.3.6         beachmat_2.17.14         </span></span>
<span><span class="co">#&gt;  [43] labeling_0.4.2            fansi_1.0.4              </span></span>
<span><span class="co">#&gt;  [45] nnls_1.4                  polyclip_1.10-4          </span></span>
<span><span class="co">#&gt;  [47] abind_1.4-5               compiler_4.3.1           </span></span>
<span><span class="co">#&gt;  [49] withr_2.5.0               tiff_0.1-11              </span></span>
<span><span class="co">#&gt;  [51] BiocParallel_1.35.3       viridis_0.6.4            </span></span>
<span><span class="co">#&gt;  [53] highr_0.10                HDF5Array_1.29.3         </span></span>
<span><span class="co">#&gt;  [55] R.utils_2.12.2            DelayedArray_0.27.10     </span></span>
<span><span class="co">#&gt;  [57] rjson_0.2.21              tools_4.3.1              </span></span>
<span><span class="co">#&gt;  [59] vipor_0.4.5               beeswarm_0.4.0           </span></span>
<span><span class="co">#&gt;  [61] httpuv_1.6.11             R.oo_1.25.0              </span></span>
<span><span class="co">#&gt;  [63] glue_1.6.2                rhdf5filters_1.13.5      </span></span>
<span><span class="co">#&gt;  [65] promises_1.2.0.1          grid_4.3.1               </span></span>
<span><span class="co">#&gt;  [67] generics_0.1.3            gtable_0.3.3             </span></span>
<span><span class="co">#&gt;  [69] spatstat.data_3.0-1       R.methodsS3_1.8.2        </span></span>
<span><span class="co">#&gt;  [71] sp_2.0-0                  utf8_1.2.3               </span></span>
<span><span class="co">#&gt;  [73] XVector_0.41.1            spatstat.geom_3.2-4      </span></span>
<span><span class="co">#&gt;  [75] pillar_1.9.0              stringr_1.5.0            </span></span>
<span><span class="co">#&gt;  [77] limma_3.57.7              later_1.3.1              </span></span>
<span><span class="co">#&gt;  [79] dplyr_1.1.2               lattice_0.21-8           </span></span>
<span><span class="co">#&gt;  [81] deldir_1.0-9              tidyselect_1.2.0         </span></span>
<span><span class="co">#&gt;  [83] locfit_1.5-9.8            scuttle_1.11.2           </span></span>
<span><span class="co">#&gt;  [85] knitr_1.43                gridExtra_2.3            </span></span>
<span><span class="co">#&gt;  [87] bookdown_0.34             edgeR_3.43.8             </span></span>
<span><span class="co">#&gt;  [89] svglite_2.1.1             xfun_0.39                </span></span>
<span><span class="co">#&gt;  [91] shinydashboard_0.7.2      statmod_1.5.0            </span></span>
<span><span class="co">#&gt;  [93] DropletUtils_1.21.0       stringi_1.7.12           </span></span>
<span><span class="co">#&gt;  [95] fftwtools_0.9-11          yaml_2.3.7               </span></span>
<span><span class="co">#&gt;  [97] evaluate_0.21             codetools_0.2-19         </span></span>
<span><span class="co">#&gt;  [99] tibble_3.2.1              BiocManager_1.30.21.1    </span></span>
<span><span class="co">#&gt; [101] cli_3.6.1                 xtable_1.8-4             </span></span>
<span><span class="co">#&gt; [103] systemfonts_1.0.4         munsell_0.5.0            </span></span>
<span><span class="co">#&gt; [105] jquerylib_0.1.4           Rcpp_1.0.11              </span></span>
<span><span class="co">#&gt; [107] png_0.1-8                 parallel_4.3.1           </span></span>
<span><span class="co">#&gt; [109] ellipsis_0.3.2            pkgdown_2.0.7            </span></span>
<span><span class="co">#&gt; [111] jpeg_0.1-10               sparseMatrixStats_1.13.0 </span></span>
<span><span class="co">#&gt; [113] bitops_1.0-7              SpatialExperiment_1.11.0 </span></span>
<span><span class="co">#&gt; [115] viridisLite_0.4.2         scales_1.2.1             </span></span>
<span><span class="co">#&gt; [117] purrr_1.0.1               crayon_1.5.2             </span></span>
<span><span class="co">#&gt; [119] rlang_1.1.1</span></span></code></pre></div>
<!-- ## Tissue mask -->
<!-- When the entirety of a circular tissue sample is encompassed within an image, the user may with to isolate this circular area, and remove background noise from the remainder of the image. This process is facilitated using the `tissueMask` parameter in `transforms`, which, when selected creates a mask of the tissue within the image. Specified tissue channels can be specified in the `tissueIndex` parameter, by default all channels are used. -->
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Nicolas Canete, Alexander Nicholls, Ellis Patrick.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
